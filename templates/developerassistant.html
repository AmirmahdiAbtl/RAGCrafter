<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Improved Chat UI</title>
  <!-- Use any icons or frameworks if desired -->
</head>
<style>
  /* Basic resets */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  /* Light theme variables */
  :root {
    --color-bg: #f5f5f5;
    --color-text: #333;
    --color-primary: #4f46e5; /* Indigo */
    --color-secondary: #ffffff;
    --color-border: #ccc;
    --color-accent: #6366f1;
    --color-error: #dc2626;
  }
  
  /* Dark theme overrides */
  html.dark {
    --color-bg: #111827;
    --color-text: #f9fafb;
    --color-primary: #8b5cf6; 
    --color-secondary: #1f2937;
    --color-border: #374151;
    --color-accent: #a78bfa;
    --color-error: #f87171;
  }
  
  /* Body styles */
  body {
    font-family: sans-serif;
    background-color: var(--color-bg);
    color: var(--color-text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  
  /* Header styles */
  .header-container {
    background-color: var(--color-secondary);
    border-bottom: 1px solid var(--color-border);
    padding: 1rem;
  }
  
  .header-content {
    margin: auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .app-title {
    font-size: 1.5rem;
    font-weight: bold;
  }
  
  .toggle-mode-btn {
    background-color: transparent;
    color: var(--color-text);
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .toggle-mode-btn:hover {
    background-color: rgba(99, 102, 241, 0.1);
  }

  .dark-icon {
    display: none;
  }

  .light-icon {
    display: block;
  }

  html.dark .dark-icon {
    display: block;
  }

  html.dark .light-icon {
    display: none;
  }
  
  /* Main container (sidebar + chat) */
  .main-container {
    flex: 1;
    display: flex;
    margin: 1rem auto;
    width: 100%;
    gap: 1rem;
  }
  
  /* Sidebar styles */
  .sidebar {
    background-color: var(--color-secondary);
    border: 1px solid var(--color-border);
    width: 300px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-radius: 0.25rem;
  }
  
  .sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: var(--color-bg);
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
  }
  
  .sidebar-title {
    font-weight: bold;
    font-size: 1.1rem;
  }
  
  .new-chat-btn {
    background-color: var(--color-primary);
    color: #fff;
    font-size: 1.4rem;
    border: none;
    cursor: pointer;
    border-radius: 0.25rem;
    width: 2rem;
    height: 2rem;
    text-align: center;
    line-height: 1.6rem;
    padding: 0;
  }
  
  .new-chat-btn:hover {
    filter: brightness(0.9);
  }
  
  /* Sidebar list */
  .sidebar-list {
    flex: 1;
    overflow-y: auto;
    list-style: none;
  }
  
  .sidebar-item {
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .sidebar-item:hover {
    background-color: rgba(99, 102, 241, 0.1); /* Indigo accent in light/dark */
  }
  
  /* Chat Section styles */
  .chat-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
  }
  
  .chat-window {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  background-color: var(--color-secondary);
  display: flex;              /* Add this */
  flex-direction: column;     /* Add this */
  gap: 0.5rem;                /* Add this */
}

/* Message bubbles */
.message-bubble {
  max-width: 70%;
  padding: 0.75rem 1rem;      /* Remove margin-bottom */
  border-radius: 0.5rem;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.message-outgoing {
  background-color: var(--color-accent);
  color: #fff;
  align-self: flex-end;       /* Replace margin-left: auto */
  text-align: right;          /* Keep text alignment */
}

.message-incoming {
  background-color: var(--color-bg);
  color: var(--color-text);
  align-self: flex-start;     /* Replace margin-right: auto */
}
  .message-error {
    background-color: var(--color-error);
    color: #fff;
    margin: 0.5rem auto;
  }
  
  /* Input Bar */
  .input-bar {
    border-top: 1px solid var(--color-border);
    background-color: var(--color-secondary);
    padding: 1rem;
  }
  
  .form-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .input-label {
    font-weight: bold;
  }
  
  .input-field {
    width: 100%;
    background-color: var(--color-bg);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    padding: 0.5rem;
    resize: none;
  }
  
  .send-btn {
    background-color: var(--color-primary);
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-radius: 0.25rem;
    align-self: flex-start;
  }
  
  .send-btn:hover {
    filter: brightness(0.9);
  }
  /* Sidebar Toggle Button */
.sidebar-toggle-btn {
    background-color: transparent;
    color: var(--color-text);
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sidebar-toggle-btn:hover {
    background-color: rgba(99, 102, 241, 0.1);
  }

  .sidebar-open-icon {
    display: block;
  }

  .sidebar-close-icon {
    display: none;
  }

  /* Sidebar Animation */
  .sidebar {
    transition: transform 0.3s ease;
    transform: translateX(0);
  }

  html.sidebar-hidden .sidebar {
    transform: translateX(-100%);
  }

  html.sidebar-hidden .main-container {
    gap: 0;
  }

  html.sidebar-hidden .sidebar-open-icon {
    display: none;
  }

  html.sidebar-hidden .sidebar-close-icon {
    display: block;
  }
  /* Responsive design */
  @media (max-width: 768px) {
    .main-container {
      flex-direction: column;
      margin: 0 auto;
      width: 100%;
    }
  
    .sidebar {
      width: 100%;
      margin-bottom: 1rem;
    }
  }
</style>
<body>
  <!-- Header -->
  <header class="header-container">
    <div class="header-content">
      <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
        <svg class="sidebar-open-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        <svg class="sidebar-close-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
      <h1 class="app-title">Improved Chat UI</h1>
      <!-- Toggle Dark/Light Mode Button -->
      <button class="toggle-mode-btn" onclick="toggleDarkMode()">
        <svg class="dark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <svg class="light-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
    </div>
  </header>

  <!-- Main content container -->
  <main class="main-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">Chat History</span>
        <!-- Create New Chat Button -->
        <button class="new-chat-btn" onclick="createNewChat()" title="Create New Chat">
          +
        </button>
      </div>
      <ul id="sidebarList" class="sidebar-list">
        {% for chat in chats %}
        <li
          class="sidebar-item"
          onclick="selectChat({{ chat[0] }})"
        >
          {{ chat[1] }}
        </li>
        {% endfor %}
      </ul>
    </aside>

    <!-- Chat Section -->
    <section class="chat-section">
      <!-- Chat Window -->
      <div id="chatWindow" class="chat-window">
        <!-- Messages dynamically inserted here -->
      </div>

      <!-- Input Area -->
      <div class="input-bar">
        <form onsubmit="sendMessage(event)" class="form-container">
          <label for="userInput" class="input-label">Message</label>
          <textarea
            id="userInput"
            class="input-field"
            rows="2"
            placeholder="Type your message..."
          ></textarea>

          <input type="hidden" id="hiddenChatId" value="" />

          <button
            type="submit"
            id="sendButton"
            class="send-btn"
          >
            Send
          </button>
        </form>
      </div>
    </section>
  </main>

  <script>
    // Dark Mode Toggling
    // Update the toggleDarkMode function to handle icon switching
  function toggleDarkMode() {
    const html = document.documentElement;
    html.classList.toggle('dark');
    
    // Store preference in localStorage
    const isDark = html.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }

  // Check for saved theme preference on page load
  document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.classList.toggle('dark', savedTheme === 'dark');
  });

    let chat_id = null;

    function appendMessage(content, classes) {
      const chatWindow = document.getElementById('chatWindow');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-bubble ${classes}`;
      // If you have Marked.js or your own markdown parser:
      // const parsedContent = marked.parse(content);
      // messageDiv.innerHTML = parsedContent;
      // Otherwise, just set textContent:
      messageDiv.textContent = content;
      chatWindow.appendChild(messageDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function selectChat(id) {
      chat_id = id;
      document.getElementById('hiddenChatId').value = id;
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.innerHTML = '';

      try {
        const response = await fetch(`/developerassistant/chat/${id}`);
        if (response.ok) {
          const data = await response.json();
          data.chat_details.forEach(([prompt, resp]) => {
            appendMessage(prompt, "message-outgoing");
            appendMessage(resp, "message-incoming");
          });
        } else {
          appendMessage('Failed to fetch chat history.', "message-error");
        }
      } catch (error) {
        appendMessage('Error fetching the chat.', "message-error");
      }
    }

    async function createNewChat() {
      try {
        const response = await fetch('/developerassistant/new_chat', {
          method: 'POST'
        });
        if (response.ok) {
          const data = await response.json();
          const newChat = document.createElement('li');
          newChat.className = "sidebar-item";
          newChat.innerText = data.chat_name;
          newChat.onclick = () => selectChat(data.chat_id);
          document.getElementById('sidebarList').prepend(newChat);
          selectChat(data.chat_id);
        } else {
          appendMessage('Error creating new chat.', "message-error");
        }
      } catch (error) {
        appendMessage('Server error creating new chat.', "message-error");
      }
    }

    async function sendMessage(event) {
      event.preventDefault();
      const textArea = document.getElementById('userInput');
      const sendButton = document.getElementById('sendButton');
      const message = textArea.value.trim();

      if (!message) return;

      const formData = new FormData();
      formData.append('chat_id', chat_id || '');
      formData.append('userInput', message);

      appendMessage(message, "message-outgoing");
      textArea.value = '';
      sendButton.disabled = true;

      try {
        const response = await fetch('/developerassistant/', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          if (data.error) {
            appendMessage(data.error, "message-error");
          } else {
            appendMessage(data.response, "message-incoming");
            if (data.chat_id) {
              chat_id = data.chat_id;
              document.getElementById('hiddenChatId').value = data.chat_id;
            }
          }
        } else {
          appendMessage('Server error submitting data.', "message-error");
        }
      } catch (error) {
        appendMessage('Error connecting to the server.', "message-error");
      } finally {
        sendButton.disabled = false;
      }
    }
        // Add these functions
    function toggleSidebar() {
      document.documentElement.classList.toggle('sidebar-hidden');
      const isHidden = document.documentElement.classList.contains('sidebar-hidden');
      localStorage.setItem('sidebarState', isHidden ? 'hidden' : 'visible');
    }

    // Update DOMContentLoaded event
    document.addEventListener('DOMContentLoaded', () => {
      // Existing theme code
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.classList.toggle('dark', savedTheme === 'dark');

      // New sidebar code
      const sidebarState = localStorage.getItem('sidebarState');
      if (sidebarState === 'hidden') {
        document.documentElement.classList.add('sidebar-hidden');
      }
    });
  </script>
</body>
</html>